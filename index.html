<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trauma Team International - Elite Medical Response</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    /* Reset + variables */
    *{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg:#0b0b0b;--primary-dark:#141414;--secondary-dark:#242424;
      --text:#f5f5f5;--muted:#9aa0a6;--accent:#e50914;--accent-2:#28a745;
    }
    html,body{height:100%}
    body{
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:linear-gradient(180deg,#000 0%, #0f0f0f 100%);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      line-height:1.5;
      min-height:100vh;
      display:flex;flex-direction:column;
    }

    /* Loading screen */
    #loadingScreen{
      position:fixed;inset:0;background:var(--bg);display:flex;
      align-items:center;justify-content:center;flex-direction:column;
      z-index:9999;transition:opacity .35s ease;
    }
    .spinner{
      width:48px;height:48px;border-radius:50%;
      border:4px solid var(--secondary-dark);border-top:4px solid var(--accent);
      animation:spin 1s linear infinite;margin-bottom:14px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Navbar */
    .navbar{display:flex;align-items:center;justify-content:space-between;padding:14px 28px;background:rgba(0,0,0,.6);border-bottom:1px solid rgba(255,255,255,.03);position:sticky;top:0;z-index:50}
    .brand{font-weight:800;font-size:1.15rem;display:flex;gap:10px;align-items:center}
    .nav{display:flex;gap:14px}
    .nav button{background:transparent;border:0;color:var(--muted);padding:8px 12px;border-radius:8px;cursor:pointer}
    .nav button:hover{color:var(--text);background:rgba(255,255,255,.02)}

    /* Hero */
    .hero{padding:80px 20px 56px;text-align:center}
    .hero h1{font-size:2.6rem;line-height:1.05;margin-bottom:12px;background:linear-gradient(90deg,#fff,var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .hero p{color:var(--muted);margin-bottom:20px}

    /* Layout */
    .container{max-width:1100px;margin:0 auto;padding:24px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px}

    /* Card */
    .card{background:var(--primary-dark);border:1px solid var(--secondary-dark);padding:20px;border-radius:12px}
    .card h3{color:var(--accent);margin-bottom:8px}

    /* Form */
    .form-box{max-width:720px;margin:0 auto;background:var(--primary-dark);border:1px solid var(--secondary-dark);padding:28px;border-radius:12px}
    .form-row{margin-bottom:14px}
    label{display:block;color:var(--muted);margin-bottom:6px;font-weight:600;font-size:.95rem}
    input,select,textarea{width:100%;padding:12px;border-radius:8px;border:1px solid #2b2b2b;background:#161616;color:var(--text);font-size:15px}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 6px 24px rgba(229,9,20,0.08)}
    .btn{display:inline-block;background:var(--accent);color:#fff;padding:12px 18px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}

    .footer{margin-top:auto;padding:28px;text-align:center;background:linear-gradient(180deg,transparent,#080808);border-top:1px solid rgba(255,255,255,.02);color:var(--muted)}

    /* Invoice modal */
    #invoiceModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.7);z-index:800}
    .invoice{width:100%;max-width:720px;background:var(--primary-dark);border:1px solid var(--secondary-dark);padding:22px;border-radius:10px}
    .invoice h2{margin-bottom:10px;color:var(--accent)}
    .row-flex{display:flex;gap:12px;flex-wrap:wrap}

    /* small */
    @media (max-width:640px){
      .hero h1{font-size:1.8rem}
      .navbar{padding:10px 14px}
    }
  </style>
</head>
<body>

  <!-- Loading -->
  <div id="loadingScreen" aria-hidden="true">
    <div class="spinner" role="progressbar" aria-label="Loading"></div>
    <div style="color:var(--muted)">Initializing Trauma Team System...</div>
  </div>

  <!-- Navbar -->
  <nav class="navbar" role="navigation" aria-label="Main">
    <div class="brand">üè• Trauma Team International</div>
    <div class="nav" role="menu">
      <button type="button" onclick="showSection('home')" role="menuitem">Home</button>
      <button type="button" onclick="showSection('booking')" role="menuitem">Book Consultation</button>
      <button type="button" onclick="showSection('about')" role="menuitem">About</button>
    </div>
  </nav>

  <!-- Home -->
  <main id="home" aria-live="polite">
    <section class="hero">
      <h1>Elite Medical Response Team</h1>
      <p>Your link to rapid, world-class trauma care ‚Äî anytime, anywhere.</p>
      <button class="btn" onclick="showSection('booking')">Book Consultation Now</button>
    </section>

    <div class="container">
      <section class="card">
        <h3>Why Trauma Team</h3>
        <p style="color:var(--muted)">Rapid dispatch, expert consultants, corporate coverage and on-the-ground emergency response.</p>
      </section>

      <section class="card mt-4" style="margin-top:18px">
        <h3>Services</h3>
        <div class="grid" style="margin-top:12px">
          <div class="card"><h3>üö® Emergency Response</h3><p style="color:var(--muted)">24/7 rapid response for life-threatening cases.</p></div>
          <div class="card"><h3>üë®‚Äç‚öïÔ∏è Consultations</h3><p style="color:var(--muted)">Book trauma & specialist consultations with instant confirmations.</p></div>
          <div class="card"><h3>üè¢ Corporate</h3><p style="color:var(--muted)">On-site medical teams & coverage for organizations.</p></div>
        </div>
      </section>
    </div>
  </main>

  <!-- Booking -->
  <section id="booking" class="hidden" aria-hidden="true">
    <div class="container">
      <h2 style="text-align:center;margin-bottom:18px">Book Your Consultation</h2>
      <div class="form-box" role="form" aria-labelledby="bookingForm">
        <form id="bookingForm" novalidate>
          <div class="form-row">
            <label for="patientName">Full name *</label>
            <input id="patientName" name="patientName" type="text" autocomplete="name" required />
          </div>

          <div class="form-row">
            <label for="email">Email address *</label>
            <input id="email" name="email" type="email" autocomplete="email" required />
          </div>

          <div class="form-row">
            <label for="doctor">Select specialist *</label>
            <select id="doctor" name="doctor" required>
              <option value="">-- Choose a Specialist --</option>
              <option value="Dr. R. Sharma">Dr. R. Sharma - Chief Medical Officer</option>
              <option value="Dr. M. Gupta">Dr. M. Gupta - Orthopedic Surgeon</option>
              <option value="Dr. Jyoti">Dr. Jyoti - Trauma Surgeon</option>
            </select>
          </div>

          <div class="form-row">
            <label for="appointmentDate">Consultation date *</label>
            <input id="appointmentDate" name="appointmentDate" type="date" required />
          </div>

          <div class="form-row">
            <label for="appointmentTime">Consultation time *</label>
            <input id="appointmentTime" name="appointmentTime" type="time" required />
          </div>

          <div class="form-row">
            <button id="submitBooking" type="button" class="btn" style="width:100%">Submit Booking Request</button>
          </div>

          <div id="formStatus" role="status" style="display:block;color:var(--muted);font-weight:600"></div>
        </form>
      </div>
    </div>
  </section>

  <!-- About -->
  <section id="about" class="hidden" aria-hidden="true">
    <div class="container">
      <h2 style="text-align:center;margin-bottom:18px">About Trauma Team</h2>
      <div class="card">
        <h3>Our Mission</h3>
        <p style="color:var(--muted)">Deliver elite trauma response using world-class clinicians and modern logistics.</p>
        <p style="margin-top:12px;color:var(--muted)">üìç Dehradun, India ¬∑ ‚úâÔ∏è dispatch@traumateam.com</p>
      </div>
    </div>
  </section>

  <!-- Invoice Modal -->
  <div id="invoiceModal" aria-hidden="true">
    <div class="invoice" role="dialog" aria-modal="true" aria-labelledby="invoiceTitle">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
        <h2 id="invoiceTitle">Consultation Received</h2>
        <button onclick="closeInvoice()" class="btn" style="background:var(--secondary-dark)">Close</button>
      </div>

      <div id="invoiceBody">
        <div class="row-flex" style="margin-bottom:12px">
          <div style="flex:1">
            <strong>Patient</strong>
            <div id="invPatient" style="color:var(--muted)"></div>
          </div>
          <div style="flex:1">
            <strong>Contact</strong>
            <div id="invEmail" style="color:var(--muted)"></div>
          </div>
        </div>

        <div class="row-flex" style="margin-bottom:12px">
          <div style="flex:1">
            <strong>Doctor</strong>
            <div id="invDoctor" style="color:var(--muted)"></div>
          </div>
          <div style="flex:1">
            <strong>Date & Time</strong>
            <div id="invDateTime" style="color:var(--muted)"></div>
          </div>
        </div>

        <div style="margin-top:12px;color:var(--muted)" id="invExtra"></div>

      </div>
    </div>
  </div>

  <footer class="footer">
    <div style="max-width:900px;margin:0 auto">
      <div style="display:flex;justify-content:center;gap:18px;flex-wrap:wrap;color:var(--muted)">
        <div>Emergency Contact: <strong style="color:var(--text)">+91 98765 43210</strong></div>
        <div>Dispatch: <strong style="color:var(--text)">dispatch@traumateam.com</strong></div>
      </div>
      <div style="margin-top:14px;color:var(--muted)">&copy; 2025 Trauma Team International</div>
    </div>
  </footer>

  <script>
  /* ==========================
     FINAL SAFE FRONTEND JS
     - Robust fetch w/ retry (1 retry)
     - Safe DOM helpers (no uncaught TypeErrors)
     - Parses backend JSON/text/HTML safely
     - Never crashes if backend response shape changes
     ========================== */

  (function(){
    // === CONFIG ===
    // Change this if your backend is different
    const API_BASE_URL = (window.API_BASE_URL || 'https://traumateam-backend-1.onrender.com').replace(/\/+$/, '');
    const BOOKINGS_PATH = '/bookings/'; // endpoint path (keeps your current backend)
    const RETRY_ON_FAILURE = true; // automatic one-time retry for cold-starts

    // === SAFE DOM HELPERS ===
    function safeById(id){ return document.getElementById(id) || null; }
    function safeSetText(id, text){
      const el = safeById(id);
      if (!el) return;
      el.textContent = text === undefined || text === null ? '' : String(text);
    }
    function showSection(name){
      const sections = ['home','booking','about'];
      sections.forEach(s=>{
        const el = safeById(s);
        if (!el) return;
        if (s === name) { el.classList.remove('hidden'); el.setAttribute('aria-hidden','false'); }
        else { el.classList.add('hidden'); el.setAttribute('aria-hidden','true'); }
      });
      window.scrollTo({top:0,behavior:'smooth'});
    }

    // Hide loading screen safely
    function hideLoading(){
      const ls = safeById('loadingScreen');
      if (!ls) return;
      ls.style.opacity = '0';
      setTimeout(()=>{ try { ls.style.display='none'; } catch(e){} }, 420);
    }

    // Small utility to safely parse JSON or fallback to text
    async function parseResponseSafely(res){
      const ct = (res.headers && res.headers.get ? res.headers.get('content-type') : '') || '';
      let body = null;
      try {
        if (ct.includes('application/json')) {
          body = await res.json();
        } else {
          body = await res.text();
        }
      } catch (err) {
        // fallback: try text
        try { body = await res.text(); } catch(e){ body = null; }
      }
      return body;
    }

    // Build a friendly error string from response body
    function deriveErrorMessage(body, status){
      if (!body) return `Request failed with status ${status}`;
      if (typeof body === 'string') {
        // try to extract small useful bit from HTML/text
        const trimmed = body.trim();
        if (trimmed.length > 0 && trimmed.length < 200) return trimmed;
        const textOnly = trimmed.replace(/<[^>]*>/g,' ').replace(/\s+/g,' ').trim();
        if (textOnly) return textOnly.substring(0,200);
        return `Request failed with status ${status}`;
      }
      if (typeof body === 'object') {
        for (const k of ['detail','message','error','errors']) {
          if (body[k]) return (Array.isArray(body[k]) ? body[k].join('; ') : String(body[k]));
        }
        // if object, try top-level keys into string
        try { return JSON.stringify(body).slice(0,400); } catch(e){}
      }
      return `Request failed with status ${status}`;
    }

    // Safe fetch wrapper with single retry
    async function safeFetchWithRetry(path, options = {}, allowRetry = true){
      const url = API_BASE_URL + path;
      const defaultHeaders = { 'Content-Type': 'application/json' };
      const fetchOpts = {
        mode: 'cors',
        credentials: 'omit',
        ...options,
        headers: { ...defaultHeaders, ...(options.headers || {}) }
      };

      // attempt
      try {
        const res = await fetch(url, fetchOpts);
        if (!res.ok) {
          const body = await parseResponseSafely(res);
          const message = deriveErrorMessage(body, res.status);
          const err = new Error(message);
          err.status = res.status;
          err.body = body;
          throw err;
        }
        // success -> parse body
        const body = await parseResponseSafely(res);
        return { ok: true, status: res.status, body };
      } catch (err) {
        // Network or parse errors
        // If it's first failure and retry allowed & RETRY_ON_FAILURE, do one retry (helps rendering cold-start)
        if (allowRetry && RETRY_ON_FAILURE) {
          try {
            // small backoff
            await new Promise(r => setTimeout(r, 900));
            const res2 = await fetch(url, fetchOpts);
            if (!res2.ok) {
              const body2 = await parseResponseSafely(res2);
              const message2 = deriveErrorMessage(body2, res2.status);
              const err2 = new Error(message2);
              err2.status = res2.status; err2.body = body2;
              throw err2;
            }
            const body2 = await parseResponseSafely(res2);
            return { ok: true, status: res2.status, body: body2 };
          } catch (err2) {
            // return error object
            return { ok:false, error: err2 };
          }
        }
        return { ok:false, error: err };
      }
    }

    // API helper
    async function createBooking(payload){
      return await safeFetchWithRetry(BOOKINGS_PATH, { method:'POST', body: JSON.stringify(payload) }, true);
    }

    // Populate invoice modal safely
    function openInvoiceModal(data){
      try {
        const patient = data.patient_name || data.patient || data.name || 'Unknown';
        const email = data.email || '‚Äî';
        const doctor = data.doctor || '‚Äî';
        const date = data.appointment_date || data.date || '';
        const time = data.appointment_time || data.time || '';
        const id = data.invoice_id || data.id || data.booking_id || 'N/A';
        safeSetText('invPatient', patient);
        safeSetText('invEmail', email);
        safeSetText('invDoctor', doctor);
        safeSetText('invDateTime', (date ? date : '') + (time ? (' ‚Ä¢ ' + time) : ''));
        safeSetText('invExtra', 'Invoice ID: ' + id);
        const modal = safeById('invoiceModal');
        if (modal) { modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
      } catch (e){
        console.error('openInvoiceModal error', e);
      }
    }

    function closeInvoice(){
      const modal = safeById('invoiceModal');
      if (modal) { modal.style.display='none'; modal.setAttribute('aria-hidden','true'); document.body.style.overflow='auto'; }
    }

    // Friendly status messages in form
    function setFormStatus(msg, isError){
      const el = safeById('formStatus');
      if (!el) return;
      el.textContent = msg || '';
      el.style.color = isError ? '#ff6666' : 'var(--muted)';
    }

    // Main booking flow (wired to button)
    async function submitBookingHandler(){
      try {
        setFormStatus('');
        const btn = safeById('submitBooking');
        if (!btn) return;

        // gather inputs (safe)
        const nameEl = safeById('patientName'), emailEl = safeById('email'),
              doctorEl = safeById('doctor'), dateEl = safeById('appointmentDate'),
              timeEl = safeById('appointmentTime');

        const name = nameEl ? (nameEl.value || '').trim() : '';
        const email = emailEl ? (emailEl.value || '').trim() : '';
        const doctor = doctorEl ? (doctorEl.value || '') : '';
        const date = dateEl ? (dateEl.value || '') : '';
        const time = timeEl ? (timeEl.value || '') : '';

        // Basic client validation
        if (!name || !email || !doctor || !date || !time){
          setFormStatus('Please complete all required fields.', true);
          return;
        }
        // email simple regex
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!re.test(email)){
          setFormStatus('Please enter a valid email address.', true);
          return;
        }

        // disable button
        btn.disabled = true;
        const originalText = btn.textContent;
        btn.textContent = 'Submitting...';

        // payload
        const payload = {
          patient_name: name,
          email: email,
          doctor: doctor,
          appointment_date: date,
          appointment_time: time,
          source: 'frontend' // small metadata for backend
        };

        // call backend
        const res = await createBooking(payload);

        if (res.ok){
          // backend success -> res.body may be object or string
          const body = res.body;
          // attempt to find helpful fields
          const safeBody = (typeof body === 'object' && body !== null) ? body : { message: String(body || '') };
          // show invoice with whatever we have
          openInvoiceModal({
            patient_name: payload.patient_name,
            email: payload.email,
            doctor: payload.doctor,
            appointment_date: payload.appointment_date,
            appointment_time: payload.appointment_time,
            invoice_id: (safeBody.invoice_id || safeBody.id || safeBody.booking_id || safeBody.reference || 'N/A')
          });
          setFormStatus('Booking created successfully ‚Äî invoice shown.', false);
        } else {
          // failure - show friendly message
          const err = res.error || new Error('Unknown error');
          const msg = (err && err.message) ? err.message : 'Booking failed';
          setFormStatus('Error: ' + msg, true);
        }

      } catch (e) {
        console.error('submitBookingHandler caught', e);
        setFormStatus('Unexpected error. Try again later.', true);
      } finally {
        const btn = safeById('submitBooking');
        if (btn) { btn.disabled = false; btn.textContent = 'Submit Booking Request'; }
      }
    }

    // Setup event listeners when DOM is ready
    document.addEventListener('DOMContentLoaded', function(){
      // hide loading
      setTimeout(hideLoading, 700);

      // set min date
      const dateEl = safeById('appointmentDate');
      if (dateEl) {
        const today = new Date().toISOString().split('T')[0];
        dateEl.setAttribute('min', today);
      }

      // wire button
      const submitBtn = safeById('submitBooking');
      if (submitBtn) submitBtn.addEventListener('click', submitBookingHandler);

      // invoice close on ESC or background click
      document.addEventListener('keydown', function(e){
        if (e.key === 'Escape') closeInvoice();
      });
      const invoiceModal = safeById('invoiceModal');
      if (invoiceModal) {
        invoiceModal.addEventListener('click', function(ev){
          if (ev.target === invoiceModal) closeInvoice();
        });
      }

      // default view
      showSection('home');

      // quick accessibility: focus first input in booking when opened
      const observer = new MutationObserver(muts=>{
        muts.forEach(m=>{
          if (m.type === 'attributes' && m.attributeName === 'class'){
            const bookingSection = safeById('booking');
            if (bookingSection && !bookingSection.classList.contains('hidden')){
              const f = safeById('patientName');
              if (f) setTimeout(()=>f.focus(), 120);
            }
          }
        });
      });
      const bookingNode = safeById('booking');
      if (bookingNode) observer.observe(bookingNode, { attributes: true });

    });

    // expose some functions for debug if needed
    window.showSection = showSection;
    window.submitBooking = submitBookingHandler;
    window.closeInvoice = closeInvoice;

  })();
  </script>
</body>
</html>
